<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/defaultLayout}">
<!--
    ë‚´ìš© : ë‚˜ì˜ ì„¤ì • êµ¬í˜„í•˜ê¸°

    - http://localhost:8080/sboard/my/setting
    - íšŒì›ì •ë³´ ìˆ˜ì • ë° íƒˆí‡´ ê¸°ëŠ¥
    - íšŒì›íƒˆí‡´ëŠ” í•´ë‹¹ ì‚¬ìš©ìì˜ ì•„ì´ë””ë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì»¬ëŸ¼ì˜ ê°’ì„ null ì—…ë°ì´íŠ¸
-->
<div class="container-fluid px-4" layout:fragment="content">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        window.onload = function (){
            const  btnChangePassword =document.getElementById('btnChangePassword');
            const  formChangePassword = document.formChangePassword;

            const inputPass2 = document.getElementById('pass2');
            const inputPass1 = document.getElementById('pass1');

            const rePass  = /^(?=.*[a-zA-z])(?=.*[0-9])(?=.*[$`~!@$!%*#^?&\\(\\)\-_=+]).{5,16}$/;

            btnChangePassword.onclick =function (e){
                e.preventDefault();
                if( inputPass1.value == inputPass2.value){

                    if(!inputPass2.value.match(rePass)){
                        alertModal('ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. \n ' +
                            'ì˜ë¬¸ ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì—¬ 5ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.')
                    }else{
                       const data = formChangePassword.submit();
                    }
                }else{
                    alertModal('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                }
            }
            const code = [[${code}]]
            if(code =='100'){
                alertModal('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            //ê°œì¸ì •ë³´ ìˆ˜ì •
         //ë„ˆë¬´ ê·€ì°®ìŒ..
            const reName  = /^[ê°€-í£]{2,10}$/
            const reNick  = /^[a-zA-Zã„±-í£0-9][a-zA-Zã„±-í£0-9]*$/;
            const reEmail = /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i;
            const reHp    = /^01(?:0|1|[6-9])-(?:\d{4})-\d{4}$/;
            const uid = `[[${user.uid}]]`;

            // ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬
            const inputName = document.getElementById('inputName');
            const resultName = document.getElementById('resultName');

            inputName.addEventListener('focusout', async () => {

                const value = inputName.value;

                if (!value.match(reName)) {
                    showResultInvalid(resultName, 'ì´ë¦„ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                } else {
                    showResultValid(resultName, '');
                    const result = await confirmModal(`${value}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                    if(result){
                      const result2 = await fetchGet(`/sboard/my/name/${value}/${uid}`);
                      if(result2.success == '100'){
                          alertModal('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                      }
                    }
                }
            });


            // ë³„ëª… ìœ íš¨ì„± ê²€ì‚¬
            const inputNick = document.getElementById('inputNick');
            const nickCheck = document.getElementById('nickCheck');

            nickCheck.onclick = function(e) {
                e.preventDefault();
                const type       = 'nick';
                const value      = inputNick.value;

                // ì •ê·œì‹ ê²€ì‚¬
                if(!value.match(reNick)){
                   alertModal("ë‹‰ë„¤ì„ í˜•ì‹ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                }else{
                    setTimeout(async () => {

                        const data = await fetchGet(`/sboard/user/${type}/${value}`);

                        if(data.result > 0){
                            alertModal("ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ë‹‰ë„¤ì„ ì…ë‹ˆë‹¤.")
                        }else{
                            const result = await confirmModal('ì‚¬ìš©ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë³€ê²½í•˜ê² ìŠµë‹ˆê¹Œ?');
                            if(result){
                                const result2 = await fetchGet(`/sboard/my/nick/${value}/${uid}`);
                                if(result2.success == '100'){
                                    alertModal('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        }
                    }, 1000);
                }

            }

            // íœ´ëŒ€í° ìœ íš¨ì„± ê²€ì‚¬
            const inputHp = document.getElementById('inputHp');
            const  resultHp =document.getElementById('resultHp');
            inputHp.addEventListener('focusout', async () => {

                const value =  inputHp.value;

                if(!value.match(reHp)){
                    showResultInvalid(resultHp, 'íœ´ëŒ€í° í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }else {
                    setTimeout(async () => {
                        const data = await fetchGet(`/sboard/user/hp/${value}`);

                        if(data.result > 0){
                            showResultInvalid(resultHp, 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ íœ´ëŒ€í° ì…ë‹ˆë‹¤.');
                        }else{
                            showResultInvalid(resultHp, '');
                            const result = await confirmModal('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                            if(result){
                                const result2 = await fetchGet(`/sboard/my/hp/${value}/${uid}`);
                                if(result2.success == '100'){
                                    alertModal('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        }
                    }, 1000);
                }
            });

            // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
            const inputEmail = document.getElementById('inputEmail');
            const btnCheckEmail = document.getElementById('btnCheckEmail');
            const insertCode = document.getElementById('insertCode');
            const emailSpinner = document.getElementById('emailSpinner');

            btnCheckEmail.onclick = function(e){
                e.preventDefault();
                const value     = inputEmail.value;
                // ìœ íš¨ì„± ê²€ì‚¬
                emailSpinner.classList.remove('d-none');
                if(!value.match(reEmail)){
                    emailSpinner.classList.add('d-none');
                   alertModal("ì´ë©”ì¼ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }else{
                    // ì´ë©”ì¼ ì¸ì¦ì½”ë“œ ë°œê¸‰ ë° ì¤‘ë³µì²´í¬
                    setTimeout(async () => {
                        const data = await fetchGet(`/sboard/user/email/${value}`);
                        console.log('data : ' + data.result);
                        if(data.result > 0){
                            emailSpinner.classList.add('d-none');
                           alertModal("ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.")
                        }else{
                            emailSpinner.classList.add('d-none');
                            alertModal("ì¸ì¦ì½”ë“œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
                            insertCode.style.display="";
                        }
                    }, 1000);
                }
                }



            // ì´ë©”ì¼ ì¸ì¦ì½”ë“œ í™•ì¸
            const inputEmailCode = document.getElementById('code');
            const btnCheckEmailCode = document.getElementById('btnCheckEmailCode');

            btnCheckEmailCode.onclick = async function (e){
                e.preventDefault();
                const value = inputEmailCode.value;
                const newEmail = inputEmail.value;
                const data = await fetchGet(`/sboard/email/${value}`);

                if(!data.result){
                    alertModal('ì¸ì¦ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
                }else{
                    const result = await confirmModal('ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                    if(result){
                        const result2 = await fetchGet(`/sboard/my/email/${newEmail}/${uid}`);
                        if(result2.success == '100'){
                            alertModal('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            insertCode.style.display="none";
                        }
                    }else{
                        insertCode.style.display="none";
                    }

                }
            }
            // ìš°í¸ë²ˆí˜¸ ì£¼ì†Œê²€ìƒ‰
            // ë‹¤ìŒ ìš°í¸ë²ˆí˜¸ API ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ ì¶”ê°€, postcode í•¨ìˆ˜ util.js íŒŒì¼ ì¶”ê°€
            const inputZip = document.getElementById('inputZip');
            inputZip.onclick = function (){
                postcode();
            }
            //íšŒì› íƒˆí‡´
            const btnLeave = document.getElementById('btnLeave');
            const btnLeaveResult = document.getElementById('btnLeaveResult');
            btnLeave.onclick = async function (e) {
                e.preventDefault();
                const result = await confirmModal('ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (result) {
                    btnLeaveResult.click();
                }else{
                    alertModal("íšŒì› íƒˆí‡´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ ìƒê° í•˜ì…¨ìŠµë‹ˆë‹¤.");
                }
            }

            const  inputAddr2 =document.getElementById('inputAddr2');
            const  inputAddr1 =document.getElementById('inputAddr1');

            inputAddr2.addEventListener("focusout", async ()=>{
                console.log(inputZip.value);
                if(inputZip.value == ""){
                    alertModal("ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”")
                }else if(inputAddr1.value == ""){
                    alertModal("ê¸°ë³¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”")
                }else{
                    const result = await confirmModal('ì£¼ì†Œë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
                    if(result){
                        const jsonData = {zip :inputZip.value,
                         addr1 : inputAddr1.value,
                        addr2 : inputAddr2.value,
                        uid: uid}

                        const result2 = await fetchPut('/sboard/my/modifyAddr', jsonData);
                        if(result2.success == '100'){
                            alertModal('ì£¼ì†Œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                        }
                }
            })
        }

    </script>

    <h3 class="mt-4 mb-4">ë‚˜ì˜ ì„¤ì • ğŸ’–</h3>
    <!-- ë‚´ìš© ì‹œì‘ -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            íšŒì›ì •ë³´ ì„¤ì •
        </div>
        <div class="card-body">
            <form name="formChangePassword" method="post" th:action="@{/my/passwordChange}">
            <table class="table">
                <tr>
                    <td >ì•„ì´ë””</td>
                    <td class="col-md-10"><input class="form-control w-50" type="text" name="uid" readonly th:value="${user.uid}"></td>
                </tr>
                <tr>
                    <td>ìƒˆ ë¹„ë°€ë²ˆí˜¸</td>
                    <td><input class="form-control w-50" type="password" name="pass1" id="pass1"></td>
                </tr>
                <tr>
                    <td >ë¹„ë°€ë²ˆí˜¸ í™•ì¸</td>
                    <td class="d-flex">
                        <input class="form-control w-50" type="password" name="pass2" id="pass2">
                        <button class="btn btn-dark ms-2" id="btnChangePassword">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </td>
                </tr>

                <tr>
                    <td>íšŒì›ê°€ì…ì¼</td>
                    <td><input class="form-control border-0" type="text" name="regDate" th:value="${user.getRegDate()}"></td>
                </tr>
            </table>
            </form>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            ê°œì¸ì •ë³´ ìˆ˜ì •
        </div>
        <div class="card-body">

            <form name="changeUser" method="post" th:action="@{/my/changeUser}">
            <table class="table">
                <tr>
                    <td class="col-md-2">ì´ë¦„</td>
                   <td class="col-md-10"><input class="form-control w-50" type="text" name="name" id="inputName" th:value="${user.name}">
                       <div id="resultName" class="d-block"></div></td>

                </tr>
                <tr>
                    <td>ë³„ëª…</td>
                    <td class="d-flex">
                        <input class="form-control w-50" type="text" name="nick"  id="inputNick" th:value="${user.nick}">
                        <button class="btn btn-dark ms-2" id="nickCheck">ì¤‘ë³µí™•ì¸</button>
                    </td>
                </tr>
                <tr>
                    <td>ì´ë©”ì¼</td>
                    <td class="d-flex">
                        <input class="form-control w-50" type="text" id="inputEmail" name="email" th:value="${user.email}">
                        <button class="btn btn-dark ms-2" id="btnCheckEmail">
                            <span class="spinner spinner-border spinner-border-sm d-none" aria-hidden="true" id="emailSpinner"></span>
                            <span class="" role="status">ì´ë©”ì¼ ì¸ì¦</span>
                        </button>
                    </td>
                </tr>
                <tr style="display: none" id="insertCode">
                    <td>ì¸ì¦ì½”ë“œ ì…ë ¥</td>
                    <td class="d-flex">
                        <input class="form-control w-50" type="text" name="email" id="code" placeholder="ì¸ì¦ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" >
                        <button class="btn btn-dark ms-2" id="btnCheckEmailCode" >ì¸ì¦ì½”ë“œ í™•ì¸</button>
                    </td>
                </tr>
                <tr>
                    <td>íœ´ëŒ€í°</td>
                    <td>
                        <input class="form-control w-50" type="text" name="hp" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥"
                               id="inputHp" th:value="${user.hp}" />
                        <div id="resultHp" class="d-block"></div>
                    </td>
                </tr>
                <tr>
                    <td>ì£¼ì†Œ</td>
                    <td>
                        <div class="mb-2">ì£¼ì†Œ ë³€ê²½ ì›í•  ì‹œ ìš°í¸ ë²ˆí˜¸ ì…ë ¥ë€ì„ í´ë¦­í•˜ì„¸ìš”</div>
                        <input class="form-control w-25 mb-2 " type="text" name="zip" readonly placeholder="ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰" id="inputZip" th:value="${user.zip}"/>
                        <input class="form-control w-75 mb-2" type="text" name="add1" readonly placeholder="ê¸°ë³¸ì£¼ì†Œ ì…ë ¥" th:value="${user.addr1}" id="inputAddr1" />
                        <input class="form-control w-75 mb-2" type="text" name="addr2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"  th:value="${user.addr2}" id="inputAddr2"/>
                    </td>
                </tr>

            </table>
            </form>
        </div>


    </div>

    <div class="text-end mb-4">
        <a th:href="@{#}" class="btn btn-danger" id="btnLeave">íšŒì›íƒˆí‡´</a>
        <a th:href="@{/my/leave(uid=${user.uid})}" class="btn btn-danger" id="btnLeaveResult" style="display: none"></a>
    </div>
    <!-- ë‚´ìš© ë -->
</div>
</html>